<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#E87722">
    <title>Benetrip - Destinos Recomendados</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/mobile-optimizations.css">
</head>
<body class="mobile-optimized">
    <!-- Barra de status estilo app -->
    <div class="native-status-bar"></div>
    
    <div id="destinos-container">
        <!-- Conteúdo de carregamento inicial -->
        <div class="loading-container">
            <img src="assets/images/tripinha/avatar-pensando.png" alt="Tripinha carregando" class="loading-avatar" />
            <div class="loading-text">Farejando destinos incríveis para você...</div>
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Elementos originais mantidos -->
        <div id="swipe-hint" class="swipe-hint" style="display:none;">
            <div class="swipe-hint-arrow">←</div>
            <div class="swipe-hint-text">Deslize para explorar</div>
        </div>
        
        <!-- Fixed bottom bar para ações principais -->
        <div id="bottom-actions" class="fixed-bottom-bar" style="display:none;">
            <button class="btn-secundario btn-voltar">Refazer Quiz</button>
            <button class="btn-principal btn-avancar">Ver Voos</button>
        </div>
    </div>

    <!-- Toast notification container -->
    <div id="toast-container"></div>

    <!-- Sistema de carregamento sequencial de scripts -->
    <script>
        // Função para carregar um script individual com fallback
        function loadScript(url, callback, errorCallback) {
            const script = document.createElement('script');
            script.src = url;
            
            script.onload = function() {
                console.log(`Script carregado: ${url}`);
                if (callback) callback();
            };
            
            script.onerror = function() {
                console.error(`Erro ao carregar script: ${url}`);
                
                // Tentar CDN alternativo para bibliotecas comuns
                if (url.includes('hammer.js')) {
                    console.log("Tentando CDN alternativo para Hammer.js...");
                    const alternativeUrl = 'https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js';
                    const alternativeScript = document.createElement('script');
                    alternativeScript.src = alternativeUrl;
                    
                    alternativeScript.onload = function() {
                        console.log(`Script carregado do CDN alternativo: ${alternativeUrl}`);
                        if (callback) callback();
                    };
                    
                    alternativeScript.onerror = function() {
                        console.error(`Erro ao carregar do CDN alternativo: ${alternativeUrl}`);
                        showErrorMessage(`Falha ao carregar recurso: ${url.split('/').pop()}`);
                        if (errorCallback) errorCallback();
                    };
                    
                    document.body.appendChild(alternativeScript);
                } else if (url.includes('lodash')) {
                    console.log("Tentando CDN alternativo para Lodash...");
                    const alternativeUrl = 'https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js';
                    const alternativeScript = document.createElement('script');
                    alternativeScript.src = alternativeUrl;
                    
                    alternativeScript.onload = function() {
                        console.log(`Script carregado do CDN alternativo: ${alternativeUrl}`);
                        if (callback) callback();
                    };
                    
                    alternativeScript.onerror = function() {
                        console.error(`Erro ao carregar do CDN alternativo: ${alternativeUrl}`);
                        showErrorMessage(`Falha ao carregar recurso: ${url.split('/').pop()}`);
                        if (errorCallback) errorCallback();
                    };
                    
                    document.body.appendChild(alternativeScript);
                } else {
                    // Para outros scripts, mostrar erro e continuar
                    showErrorMessage(`Falha ao carregar recurso: ${url.split('/').pop()}`);
                    if (errorCallback) errorCallback();
                }
            };
            
            document.body.appendChild(script);
        }
        
        // Função para carregar scripts em sequência
        function loadScriptsSequentially(scripts, callback) {
            if (scripts.length === 0) {
                if (callback) callback();
                return;
            }
            
            const nextScript = scripts.shift();
            
            loadScript(nextScript, function() {
                loadScriptsSequentially(scripts, callback);
            }, function() {
                // Continuar mesmo em caso de erro
                loadScriptsSequentially(scripts, callback);
            });
        }
        
        // Função para mostrar mensagem de erro
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mensagem-erro';
            errorDiv.innerHTML = `
                <div class="erro-conteudo">
                    <span class="erro-icone">⚠️</span>
                    <p>${message}</p>
                    <button class="btn-fechar-erro">OK</button>
                </div>
            `;
            
            document.body.appendChild(errorDiv);
            
            // Configurar evento para fechar
            errorDiv.querySelector('.btn-fechar-erro').addEventListener('click', () => {
                document.body.removeChild(errorDiv);
            });
            
            // Fechar automaticamente após 5 segundos
            setTimeout(() => {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 5000);
        }
        
        // Função para verificar e corrigir as URLs de API
        function checkAndFixAPIURLs() {
            if (window.BENETRIP_AI) {
                // Patch para corrigir as URLs de API
                window.BENETRIP_AI.callAIService = function(prompt) {
                    console.log("Chamando API interceptada e corrigida para Netlify Functions");
                    // Usar a URL correta para funções Netlify
                    return fetch('https://benetrip.netlify.app/.netlify/functions/ai-recommend', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(prompt)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro na API: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => data.data);
                };
                
                // Patch para corrigir callNetlifyFunction
                window.BENETRIP_AI.callNetlifyFunction = function(preferences) {
    console.log("Chamando função proxy para recomendações");
    return fetch('/.netlify/functions/proxy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(preferences)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erro no proxy: ${response.status}`);
        }
        return response.json();
    })
    .then(data => data.data);
};
                
                // Patch para corrigir getDestinationImages
                window.BENETRIP_AI.getDestinationImages = function(destino) {
                    try {
                        const query = `${destino.cidade} ${destino.pais} landmark`;
                        const encodedQuery = encodeURIComponent(query);
                        
                        return fetch(`https://benetrip.netlify.app/.netlify/functions/image-search?query=${encodedQuery}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`Erro na API de imagens: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.images && data.images.length > 0) {
                                    return {
                                        principal: data.images[0].url,
                                        secundaria: data.images.length > 1 ? data.images[1].url : data.images[0].url
                                    };
                                }
                                throw new Error("Nenhuma imagem encontrada");
                            })
                            .catch(error => {
                                console.error(`Erro ao buscar imagens para ${destino.cidade}:`, error);
                                return {
                                    principal: `https://via.placeholder.com/800x600.png?text=${encodeURIComponent(destino.cidade)}`,
                                    secundaria: `https://via.placeholder.com/800x600.png?text=${encodeURIComponent(destino.pais)}`
                                };
                            });
                    } catch (error) {
                        console.error(`Erro ao buscar imagens para ${destino.cidade}:`, error);
                        return {
                            principal: `https://via.placeholder.com/800x600.png?text=${encodeURIComponent(destino.cidade)}`,
                            secundaria: `https://via.placeholder.com/800x600.png?text=${encodeURIComponent(destino.pais)}`
                        };
                    }
                };
                
                // Usar sempre as funções do Netlify para produção
                window.BENETRIP_AI.config.useNetlifyFunctions = true;
                
                console.log("APIs corrigidas para usar caminhos Netlify Functions");
            } else {
                console.warn("BENETRIP_AI não está disponível para correção de URLs");
            }
        }
        
        // Iniciar carregamento sequencial
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Iniciando carregamento de scripts");
            
            // Primeiro carregar config e dependências essenciais em ordem
            const essentialScripts = [
                "https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js",
                "assets/js/config.js"
            ];
            
            loadScriptsSequentially(essentialScripts, function() {
                console.log("Dependências essenciais carregadas");
                
                // Verificar e inicializar config
                if (window.BENETRIP_CONFIG) {
                    try {
                        window.BENETRIP_CONFIG.init();
                        console.log("BENETRIP_CONFIG inicializado com sucesso");
                    } catch (error) {
                        console.error("Erro ao inicializar BENETRIP_CONFIG:", error);
                    }
                } 
                
                if (!window.BENETRIP_CONFIG || !window.BENETRIP_CONFIG.initialized) {
                    console.warn("BENETRIP_CONFIG não disponível ou não inicializado, criando stub...");
                    // Criar stub de config para permitir que o sistema continue
                    window.BENETRIP_CONFIG = {
                        credentials: {},
                        initialized: true,
                        isProduction: true,
                        getApiUrl: function(endpoint) {
                            // Converter o nome do endpoint para o formato correto de função Netlify
                            return `https://benetrip.netlify.app/.netlify/functions/${endpoint.replace('Recommend', '-recommend').replace('Search', '-search')}`;
                        },
                        init: function() { return this; }
                    };
                }
                
                // Carregar os scripts da aplicação com sincronização garantida
                const appScripts = [
                    "assets/js/api.js",
                    "assets/js/ai-service.js"
                ];
                
                loadScriptsSequentially(appScripts, function() {
                    console.log("Scripts de API e IA carregados");
                    
                    // Inicializar serviços em sequência garantida
                    if (window.BENETRIP_API) {
                        window.BENETRIP_API.init();
                        console.log("API inicializada");
                    }
                    
                    if (window.BENETRIP_AI) {
                        window.BENETRIP_AI.init();
                        console.log("Serviço de IA inicializado");
                    }
                    
                    // Corrigir URLs de API antes de inicializar a UI
                    checkAndFixAPIURLs();
                    
                    // Finalmente carregar e inicializar a UI
                    loadScriptsSequentially(["assets/js/destinos.js"], function() {
                        console.log("UI carregada");
                        
                        if (window.BENETRIP_DESTINOS) {
                            window.BENETRIP_DESTINOS.init();
                            console.log("Sistema de destinos inicializado");
                        }
                        
                        // Código para elementos visuais
                        const isFirstVisit = !localStorage.getItem('benetrip_swipe_hint_shown');
                        if (isFirstVisit) {
                            setTimeout(() => {
                                const swipeHint = document.getElementById('swipe-hint');
                                if (swipeHint) {
                                    swipeHint.style.display = 'flex';
                                    setTimeout(() => { swipeHint.style.opacity = '1'; }, 100);
                                    setTimeout(() => {
                                        swipeHint.style.opacity = '0';
                                        setTimeout(() => { swipeHint.style.display = 'none'; }, 500);
                                    }, 3000);
                                    localStorage.setItem('benetrip_swipe_hint_shown', 'true');
                                }
                            }, 2000);
                        }
                        
                        // Mostrar barra inferior
                        setTimeout(() => {
                            const bottomBar = document.getElementById('bottom-actions');
                            if (bottomBar) bottomBar.style.display = 'flex';
                        }, 1000);
                        
                        // Carregar scripts de interação mobile no final, usando diretamente CDN confiável
                        loadScriptsSequentially([
                            "https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js",
                            "assets/js/mobile-interactions.js"
                        ]);
                    });
                });
            });
        });
    </script>
</body>
</html>
