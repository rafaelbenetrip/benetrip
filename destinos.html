
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#E87722">
    <title>Benetrip - Destinos Recomendados</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/mobile-optimizations.css">
    <style>
        /* Estilos para barra de progresso */
        .progress-bar-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 10px;
            margin: 0.5rem 0 1rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 10px;
            background-color: #E87722;
            width: 0%;
            transition: width 0.5s ease;
        }
        /* Animações para carregamento */
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        .loading-avatar {
            animation: pulse 1.5s infinite alternate;
        }
        /* Estilos para header e conteúdo */
        .app-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        .app-header h1 {
            margin: 0 auto;
            font-size: 1.2rem;
        }
        .btn-voltar {
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }
    </style>
</head>
<body class="mobile-optimized">
    <!-- Barra de status estilo app -->
    <div class="native-status-bar"></div>
    
    <div class="container">
        <!-- Header com botão de voltar -->
        <header class="app-header">
            <button id="btn-voltar" class="btn-voltar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h1>Destinos Recomendados</h1>
        </header>
    
        <!-- Conteúdo principal -->
        <main id="destinos-container">
            <!-- Conteúdo de carregamento inicial -->
            <div class="loading-container">
                <img src="assets/images/tripinha/avatar-pensando.png" alt="Tripinha carregando" class="loading-avatar" />
                <div class="loading-text">Farejando destinos incríveis para você...</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="loading-spinner"></div>
            </div>
            
            <!-- Interface principal (hidden inicialmente) -->
            <div id="conteudo-recomendacoes" class="hidden">
                <div id="mensagem-tripinha"></div>
                <div id="destino-destaque" class="mt-4"></div>
                <div id="destinos-alternativos" class="mt-4"></div>
                <div id="opcao-surpresa" class="mt-4"></div>
            </div>
            
            <!-- Mensagem de erro (hidden inicialmente) -->
            <div id="erro-recomendacoes" class="hidden bg-red-100 text-red-700 p-4 rounded-lg my-4 text-center">
                <p id="mensagem-erro" class="font-bold"></p>
                <button id="btn-tentar-novamente" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                    Tentar Novamente
                </button>
            </div>
            
            <!-- Elementos da versão anterior -->
            <div id="swipe-hint" class="swipe-hint" style="display:none;">
                <div class="swipe-hint-arrow">←</div>
                <div class="swipe-hint-text">Deslize para explorar</div>
            </div>
            
            <!-- Fixed bottom bar para ações principais -->
            <div id="bottom-actions" class="fixed-bottom-bar" style="display:none;">
                <button class="btn-secundario btn-voltar">Refazer Quiz</button>
                <button class="btn-principal btn-avancar">Ver Voos</button>
            </div>
        </main>
    </div>

    <!-- Toast notification container -->
    <div id="toast-container"></div>

    <!-- Sistema de carregamento sequencial de scripts -->
    <script>
        // Função para carregar um script individual com fallback
        function loadScript(url, callback, errorCallback) {
            const script = document.createElement('script');
            script.src = url;
            
            script.onload = function() {
                console.log(`Script carregado: ${url}`);
                if (callback) callback();
            };
            
            script.onerror = function() {
                console.error(`Erro ao carregar script: ${url}`);
                
                // Tentar CDN alternativo para bibliotecas comuns
                if (url.includes('hammer.js')) {
                    console.log("Tentando CDN alternativo para Hammer.js...");
                    const alternativeUrl = 'https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js';
                    const alternativeScript = document.createElement('script');
                    alternativeScript.src = alternativeUrl;
                    
                    alternativeScript.onload = function() {
                        console.log(`Script carregado do CDN alternativo: ${alternativeUrl}`);
                        if (callback) callback();
                    };
                    
                    alternativeScript.onerror = function() {
                        console.error(`Erro ao carregar do CDN alternativo: ${alternativeUrl}`);
                        showErrorMessage(`Falha ao carregar recurso: ${url.split('/').pop()}`);
                        if (errorCallback) errorCallback();
                    };
                    
                    document.body.appendChild(alternativeScript);
                } else if (url.includes('lodash')) {
                    console.log("Tentando CDN alternativo para Lodash...");
                    const alternativeUrl = 'https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js';
                    const alternativeScript = document.createElement('script');
                    alternativeScript.src = alternativeUrl;
                    
                    alternativeScript.onload = function() {
                        console.log(`Script carregado do CDN alternativo: ${alternativeUrl}`);
                        if (callback) callback();
                    };
                    
                    alternativeScript.onerror = function() {
                        console.error(`Erro ao carregar do CDN alternativo: ${alternativeUrl}`);
                        showErrorMessage(`Falha ao carregar recurso: ${url.split('/').pop()}`);
                        if (errorCallback) errorCallback();
                    };
                    
                    document.body.appendChild(alternativeScript);
                } else {
                    // Para outros scripts, mostrar erro e continuar
                    showErrorMessage(`Falha ao carregar recurso: ${url.split('/').pop()}`);
                    if (errorCallback) errorCallback();
                }
            };
            
            document.body.appendChild(script);
        }
        
        // Função para carregar scripts em sequência
        function loadScriptsSequentially(scripts, callback) {
            if (scripts.length === 0) {
                if (callback) callback();
                return;
            }
            
            const nextScript = scripts.shift();
            
            loadScript(nextScript, function() {
                loadScriptsSequentially(scripts, callback);
            }, function() {
                // Continuar mesmo em caso de erro
                loadScriptsSequentially(scripts, callback);
            });
        }
        
        // Função para mostrar mensagem de erro
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mensagem-erro';
            errorDiv.innerHTML = `
                <div class="erro-conteudo">
                    <span class="erro-icone">⚠️</span>
                    <p>${message}</p>
                    <button class="btn-fechar-erro">OK</button>
                </div>
            `;
            
            document.body.appendChild(errorDiv);
            
            // Configurar evento para fechar
            errorDiv.querySelector('.btn-fechar-erro').addEventListener('click', () => {
                document.body.removeChild(errorDiv);
            });
            
            // Fechar automaticamente após 5 segundos
            setTimeout(() => {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 5000);
        }
        
        // Função para verificar e corrigir as URLs de API (crucial para funcionamento)
        function checkAndFixAPIURLs() {
            if (window.BENETRIP_AI) {
                // Patch para corrigir callNetlifyFunction para trabalhar com proxy corretamente
                window.BENETRIP_AI.callNetlifyFunction = function(preferences) {
                    console.log("Chamando função proxy para recomendações");
                    return fetch('/.netlify/functions/proxy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(preferences)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro no proxy: ${response.status}`);
                        }
                        return response.json();
                    });
                };
                
                // Garantir que as URLs sempre usem funções Netlify
                window.BENETRIP_AI.config = window.BENETRIP_AI.config || {};
                window.BENETRIP_AI.config.useNetlifyFunctions = true;
                window.BENETRIP_AI.config.fallbackEndpoint = '/.netlify/functions/proxy';
                
                // Adicionar manipulador de eventos de progresso para atualizar a barra
                const origReportarProgresso = window.BENETRIP_AI.reportarProgresso;
                if (origReportarProgresso) {
                    window.BENETRIP_AI.reportarProgresso = function(fase, porcentagem, mensagem) {
                        // Chamar implementação original
                        origReportarProgresso.call(window.BENETRIP_AI, fase, porcentagem, mensagem);
                        
                        // Atualizar barra de progresso
                        const barraProgresso = document.querySelector('.progress-bar');
                        const textoProgresso = document.querySelector('.loading-text');
                        
                        if (barraProgresso) {
                            barraProgresso.style.width = `${porcentagem}%`;
                            barraProgresso.setAttribute('aria-valuenow', porcentagem);
                        }
                        
                        if (textoProgresso && mensagem) {
                            textoProgresso.textContent = mensagem;
                        }
                    };
                }
                
                console.log("APIs corrigidas para usar caminhos Netlify Functions");
            } else {
                console.warn("BENETRIP_AI não está disponível para correção de URLs");
            }
        }
        
        // Eventos DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Iniciando carregamento de scripts");
            
            // Configurar manipulador para botão de voltar
            document.getElementById('btn-voltar').addEventListener('click', function() {
                window.location.href = 'index.html';
            });
            
            // Primeiro carregar config e dependências essenciais em ordem
            const essentialScripts = [
                "https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js",
                "assets/js/config.js"
            ];
            
            loadScriptsSequentially(essentialScripts, function() {
                console.log("Dependências essenciais carregadas");
                
                // Verificar e inicializar config
                if (window.BENETRIP_CONFIG) {
                    try {
                        window.BENETRIP_CONFIG.init();
                        console.log("BENETRIP_CONFIG inicializado com sucesso");
                    } catch (error) {
                        console.error("Erro ao inicializar BENETRIP_CONFIG:", error);
                    }
                } 
                
                if (!window.BENETRIP_CONFIG || !window.BENETRIP_CONFIG.initialized) {
                    console.warn("BENETRIP_CONFIG não disponível ou não inicializado, criando stub...");
                    // Criar stub de config para permitir que o sistema continue
                    window.BENETRIP_CONFIG = {
                        credentials: {},
                        initialized: true,
                        isProduction: true,
                        getApiUrl: function(endpoint) {
                            // Converter o nome do endpoint para o formato correto de função Netlify
                            return `/.netlify/functions/${endpoint.replace('Recommend', '-recommend').replace('Search', '-search')}`;
                        },
                        init: function() { return this; }
                    };
                }
                
                // Carregar os scripts da aplicação com sincronização garantida
                loadScriptsSequentially(["assets/js/ai-service.js"], function() {
                    console.log("Serviço de IA carregado");
                    
                    if (window.BENETRIP_AI) {
                        // Inicializar o serviço de IA
                        if (typeof window.BENETRIP_AI.init === 'function' && !window.BENETRIP_AI.initialized) {
                            window.BENETRIP_AI.init();
                        }
                        
                        // Aplicar correções críticas de URL
                        checkAndFixAPIURLs();
                        
                        // Em seguida, carregar e inicializar o módulo de destinos
                        loadScriptsSequentially(["assets/js/destinos.js"], function() {
                            console.log("Módulo de destinos carregado");
                            
                            if (window.BENETRIP_DESTINOS) {
                                // Forçar o uso das funções do ai-service.js corrigidas
                                const origBuscarRecomendacoes = window.BENETRIP_DESTINOS.buscarRecomendacoes;
                                if (origBuscarRecomendacoes) {
                                    window.BENETRIP_DESTINOS.buscarRecomendacoes = async function() {
                                        try {
                                            // Iniciar barra de progresso
                                            const barra = document.querySelector('.progress-bar');
                                            if (barra) barra.style.width = '10%';
                                            
                                            // Continuar com implementação original
                                            return await origBuscarRecomendacoes.call(window.BENETRIP_DESTINOS);
                                        } catch (error) {
                                            console.error("Erro capturado na busca de recomendações:", error);
                                            
                                            // Esconder a barra de progresso em caso de erro
                                            const container = document.querySelector('.loading-container');
                                            if (container) container.style.display = 'none';
                                            
                                            // Mostrar erro com UI consistente
                                            const errorContainer = document.getElementById('erro-recomendacoes');
                                            const errorMsg = document.getElementById('mensagem-erro');
                                            
                                            if (errorContainer && errorMsg) {
                                                errorMsg.textContent = error.message || "Não foi possível carregar recomendações";
                                                errorContainer.style.display = 'block';
                                            } else {
                                                showErrorMessage(error.message || "Erro ao carregar destinos");
                                            }
                                            
                                            throw error; // Re-throw para manter o fluxo original
                                        }
                                    };
                                }
                                
                                // Inicializar o módulo de destinos
                                window.BENETRIP_DESTINOS.init();
                                console.log("Sistema de destinos inicializado");
                            }
                            
                            // Código para elementos visuais
                            const isFirstVisit = !localStorage.getItem('benetrip_swipe_hint_shown');
                            if (isFirstVisit) {
                                setTimeout(() => {
                                    const swipeHint = document.getElementById('swipe-hint');
                                    if (swipeHint) {
                                        swipeHint.style.display = 'flex';
                                        setTimeout(() => { swipeHint.style.opacity = '1'; }, 100);
                                        setTimeout(() => {
                                            swipeHint.style.opacity = '0';
                                            setTimeout(() => { swipeHint.style.display = 'none'; }, 500);
                                        }, 3000);
                                        localStorage.setItem('benetrip_swipe_hint_shown', 'true');
                                    }
                                }, 2000);
                            }
                            
                            // Mostrar barra inferior
                            setTimeout(() => {
                                const bottomBar = document.getElementById('bottom-actions');
                                if (bottomBar) bottomBar.style.display = 'flex';
                            }, 1000);
                            
                            // Configuração da barra fixa de ações
                            const btnRefazer = document.querySelector('.btn-voltar');
                            if (btnRefazer) {
                                btnRefazer.addEventListener('click', function() {
                                    window.location.href = 'index.html';
                                });
                            }
                            
                            const btnAvancar = document.querySelector('.btn-avancar');
                            if (btnAvancar) {
                                btnAvancar.addEventListener('click', function() {
                                    if (window.BENETRIP_DESTINOS.estado.destinoSelecionado) {
                                        window.BENETRIP_DESTINOS.prosseguirParaVoos();
                                    } else {
                                        showErrorMessage("Selecione um destino primeiro!");
                                    }
                                });
                            }
                            
                            // Carregar scripts de interação mobile no final
                            loadScriptsSequentially([
                                "https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js",
                                "assets/js/mobile-interactions.js"
                            ]);
                        });
                    } else {
                        showErrorMessage("Não foi possível carregar o serviço de IA. Tente recarregar a página.");
                    }
                });
            });
        });
    </script>
</body>
</html>
