<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste Amadeus - Benetrip</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { max-width: 900px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #E87722; text-align: center; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        input:focus, select:focus { border-color: #00A3E0; outline: none; }
        .row { display: flex; gap: 15px; }
        .row .form-group { flex: 1; }
        button { width: 100%; padding: 15px; background: #E87722; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        button:hover { background: #d16a1f; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #loading { display: none; text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #E87722; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #results { display: none; }
        .stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box { flex: 1; min-width: 100px; background: #00A3E0; color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-box .number { font-size: 28px; font-weight: bold; }
        .stat-box .label { font-size: 12px; opacity: 0.9; }
        .destination-list { max-height: 500px; overflow-y: auto; }
        .destination { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .destination:hover { background: #f9f9f9; }
        .dest-code { font-size: 24px; font-weight: bold; color: #E87722; }
        .dest-name { color: #666; font-size: 14px; }
        .dest-dates { color: #999; font-size: 12px; margin-top: 4px; }
        .price-eur { font-size: 24px; font-weight: bold; color: #00A3E0; }
        .price-brl { font-size: 14px; color: #666; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; }
        .warning { background: #fff3e0; color: #e65100; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .info { background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .success { background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .raw-json { background: #263238; color: #aed581; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow: auto; white-space: pre-wrap; }
        .toggle-json { background: #607d8b; margin-top: 15px; font-size: 14px; }
        #rawJson { display: none; margin-top: 15px; }
        .quick-btns { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .quick-btn { flex: 1; min-width: 80px; padding: 10px; background: #f5f5f5; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 14px; text-align: center; }
        .quick-btn:hover { border-color: #00A3E0; background: #e3f2fd; }
        .quick-btn.active { border-color: #E87722; background: #fff3e0; }
    </style>
</head>
<body>
    <h1>üß™ Teste API Amadeus</h1>
    
    <div class="card">
        <div class="warning">
            ‚ö†Ô∏è <strong>AMBIENTE DE TESTE:</strong> A Amadeus s√≥ tem dados para algumas origens no ambiente test. 
            Use <strong>MAD, NYC, LON, PAR</strong> para testar. GRU/Brasil N√ÉO est√° dispon√≠vel no teste.
        </div>
        
        <div class="form-group">
            <label>‚úàÔ∏è Aeroporto de Origem (c√≥digo IATA)</label>
            <div class="quick-btns">
                <div class="quick-btn active" onclick="setOrigin('MAD')">üá™üá∏ MAD</div>
                <div class="quick-btn" onclick="setOrigin('NYC')">üá∫üá∏ NYC</div>
                <div class="quick-btn" onclick="setOrigin('LON')">üá¨üáß LON</div>
                <div class="quick-btn" onclick="setOrigin('PAR')">üá´üá∑ PAR</div>
                <div class="quick-btn" onclick="setOrigin('MIA')">üá∫üá∏ MIA</div>
            </div>
            <input type="text" id="origin" value="MAD" maxlength="3" placeholder="Ex: MAD, NYC, LON" style="text-transform: uppercase;">
        </div>
        
        <div class="row">
            <div class="form-group">
                <label>üìÖ Data de Ida (opcional)</label>
                <input type="date" id="departureDate">
            </div>
            <div class="form-group">
                <label>üìÖ Data de Volta (opcional)</label>
                <input type="date" id="returnDate">
            </div>
        </div>
        
        <div class="row">
            <div class="form-group">
                <label>üí∞ Or√ßamento M√°ximo em EUR (opcional)</label>
                <input type="number" id="maxPrice" placeholder="Ex: 200" min="0">
            </div>
            <div class="form-group">
                <label>‚è±Ô∏è Dura√ß√£o em dias (opcional)</label>
                <input type="text" id="duration" placeholder="Ex: 7 ou 3,10">
                <small style="color:#666">N√∫mero √∫nico ou range (min,max)</small>
            </div>
        </div>
        
        <button id="searchBtn" onclick="buscarDestinos()">
            üîç Buscar Destinos
        </button>
    </div>
    
    <div id="loading" class="card">
        <div class="spinner"></div>
        <p>Buscando destinos na Amadeus...</p>
    </div>
    
    <div id="results">
        <div class="card">
            <div id="avisoBox" class="warning" style="display:none;"></div>
            <div id="successBox" class="success" style="display:none;"></div>
            
            <h2>üìä Resultados</h2>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="number" id="totalCount">0</div>
                    <div class="label">Destinos</div>
                </div>
                <div class="stat-box" style="background: #E87722;">
                    <div class="number" id="cheapestPrice">-</div>
                    <div class="label">Mais Barato</div>
                </div>
                <div class="stat-box" style="background: #4caf50;">
                    <div class="number" id="avgPrice">-</div>
                    <div class="label">Pre√ßo M√©dio</div>
                </div>
            </div>
            
            <h3>üåç Destinos Encontrados</h3>
            <div class="destination-list" id="destinationList"></div>
            
            <button class="toggle-json" onclick="toggleJson()">
                üìã Ver/Ocultar JSON Bruto
            </button>
            
            <div id="rawJson">
                <pre class="raw-json" id="jsonContent"></pre>
            </div>
        </div>
    </div>
    
    <div id="errorBox" class="card error" style="display: none;">
        <strong>‚ùå Erro:</strong> <span id="errorMessage"></span>
        <div id="errorSugestao" style="margin-top:10px;"></div>
    </div>

    <script>
        const TAXA_EUR_BRL = 6.0;
        
        function setOrigin(code) {
            document.getElementById('origin').value = code;
            document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        async function buscarDestinos() {
            const origin = document.getElementById('origin').value.toUpperCase().trim();
            const departureDate = document.getElementById('departureDate').value;
            const returnDate = document.getElementById('returnDate').value;
            const maxPrice = document.getElementById('maxPrice').value;
            const duration = document.getElementById('duration').value;
            
            if (!origin || origin.length !== 3) {
                alert('Insira um c√≥digo IATA v√°lido (3 letras)');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            
            try {
                // Montar body - s√≥ envia o que foi preenchido
                const body = { origin };
                if (departureDate) body.departureDate = departureDate;
                if (returnDate) body.returnDate = returnDate;
                if (maxPrice) body.maxPrice = parseInt(maxPrice);
                if (duration) body.duration = duration;
                
                console.log('Enviando:', body);
                
                const response = await fetch('/api/amadeus-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw { 
                        message: data.error || 'Erro na API',
                        sugestao: data.sugestao,
                        detalhes: data.detalhes
                    };
                }
                
                exibirResultados(data);
                
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorSugestao').innerHTML = error.sugestao ? 
                    `<strong>üí° Sugest√£o:</strong> ${error.sugestao}` : '';
                document.getElementById('errorBox').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
            }
        }
        
        function exibirResultados(data) {
            const destinations = data.destinations || [];
            
            // Aviso
            if (data.avisoTeste) {
                document.getElementById('avisoBox').textContent = data.avisoTeste;
                document.getElementById('avisoBox').style.display = 'block';
            } else {
                document.getElementById('avisoBox').style.display = 'none';
            }
            
            // Success
            document.getElementById('successBox').innerHTML = 
                `‚úÖ Busca realizada com sucesso! Ambiente: <strong>${data.ambiente}</strong> | Moeda: <strong>${data.currency}</strong>`;
            document.getElementById('successBox').style.display = 'block';
            
            // Stats
            document.getElementById('totalCount').textContent = destinations.length;
            
            if (destinations.length > 0) {
                const prices = destinations.map(d => d.price);
                const cheapest = Math.min(...prices);
                const avg = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
                document.getElementById('cheapestPrice').textContent = `‚Ç¨${cheapest}`;
                document.getElementById('avgPrice').textContent = `‚Ç¨${avg}`;
            } else {
                document.getElementById('cheapestPrice').textContent = '-';
                document.getElementById('avgPrice').textContent = '-';
            }
            
            // Lista de destinos
            const listHtml = destinations.map(dest => {
                const priceBRL = Math.round(dest.price * TAXA_EUR_BRL);
                return `
                    <div class="destination">
                        <div class="dest-info">
                            <div class="dest-code">${dest.iataCode}</div>
                            <div class="dest-name">${dest.cityName}</div>
                            <div class="dest-dates">üìÖ ${dest.departureDate || '?'} ‚Üí ${dest.returnDate || '?'}</div>
                        </div>
                        <div class="dest-price">
                            <div class="price-eur">‚Ç¨${dest.price}</div>
                            <div class="price-brl">‚âà R$ ${priceBRL.toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('destinationList').innerHTML = listHtml || 
                '<p style="text-align:center;color:#999;padding:20px;">Nenhum destino encontrado. Tente remover filtros.</p>';
            
            // JSON bruto
            document.getElementById('jsonContent').textContent = JSON.stringify(data, null, 2);
            
            document.getElementById('results').style.display = 'block';
        }
        
        function toggleJson() {
            const jsonDiv = document.getElementById('rawJson');
            jsonDiv.style.display = jsonDiv.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>
